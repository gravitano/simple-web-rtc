<!DOCTYPE html>
<html>
  <body>
    <h2>Simple Video Chat</h2>
    <video id="local" autoplay playsinline muted></video>
    <video id="remote" autoplay playsinline></video>
    <script>
      const ws = new WebSocket('ws://localhost:3001');
      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      const localVideo = document.getElementById('local');
      const remoteVideo = document.getElementById('remote');

      ws.onopen = () => ws.send(JSON.stringify({ type: 'join', room: 'demo' }));

      ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.type === 'signal') {
          const { sdp, candidate } = data.payload;
          if (sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(sdp));
            if (sdp.type === 'offer') {
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ type: 'signal', payload: { sdp: answer } }));
            }
          } else if (candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
          }
        }
      };

      pc.onicecandidate = (e) => {
        if (e.candidate)
          ws.send(JSON.stringify({ type: 'signal', payload: { candidate: e.candidate } }));
      };

      pc.ontrack = (e) => (remoteVideo.srcObject = e.streams[0]);

      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
        localVideo.srcObject = stream;
        stream.getTracks().forEach((t) => pc.addTrack(t, stream));
        pc.createOffer().then(async (offer) => {
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify({ type: 'signal', payload: { sdp: offer } }));
        });
      });
    </script>
  </body>
</html>
